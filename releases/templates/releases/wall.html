{% extends "base.html" %}
{% load static %}

{% block title %}Flip House Records - The Wall{% endblock %}

{% block extra_css %}
<style>
  :root {
    --white: #ffffff;
    --dim: rgba(255,255,255,0.5);
    --faint: rgba(255,255,255,0.08);
    --border: rgba(255,255,255,0.15);
  }

  .page-wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 110px 16px 80px;
  }

  .page-title {
    text-align: center;
    font-size: 2.6rem;
    letter-spacing: 5px;
    margin-bottom: 6px;
    text-shadow: 0 0 30px rgba(255,255,255,0.4);
  }

  .page-sub {
    text-align: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    color: var(--dim);
    letter-spacing: 3px;
    margin-bottom: 50px;
  }

  .section-header {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 4px;
    color: rgba(255,255,255,0.35);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    margin-bottom: 22px;
  }

  .canvas-section { margin-bottom: 60px; }

  .canvas-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .tool-btn {
    background: var(--faint);
    border: 1px solid var(--border);
    color: #fff;
    padding: 7px 16px;
    border-radius: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
  }
  .tool-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
  .tool-btn.active { background: #fff; color: #000; border-color: #fff; }

  .size-slider-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    color: var(--dim);
  }
  #brushSize { width: 80px; accent-color: #fff; }

  .color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s;
    flex-shrink: 0;
  }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.selected { border-color: #fff; transform: scale(1.2); }

  #colorPicker {
    width: 32px;
    height: 32px;
    border: 2px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    background: none;
    padding: 0;
  }

  .canvas-outer {
    position: relative;
    border: 2px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    background: #111;
    box-shadow: 0 0 40px rgba(255,255,255,0.06);
    touch-action: none;
  }

  #wallCanvas {
    display: block;
    width: 100%;
    cursor: crosshair;
    image-rendering: pixelated;
  }

  .canvas-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    color: rgba(255,255,255,0.3);
    margin-top: 10px;
    letter-spacing: 1px;
  }

  /* Main canvas D-pad */
  .main-dpad {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: grid;
    grid-template-columns: repeat(3, 34px);
    grid-template-rows: repeat(3, 34px);
    gap: 3px;
    z-index: 5;
  }
  .main-dpad .dpad-btn {
    background: rgba(0,0,0,0.75);
    border: 1px solid rgba(255,255,255,0.18);
    color: #fff;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    user-select: none;
    -webkit-user-select: none;
  }
  .main-dpad .dpad-btn:hover  { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.5); }
  .main-dpad .dpad-btn:active { background: rgba(255,255,255,0.28); transform: scale(0.92); }
  .main-dpad .dpad-btn.empty  { background: none; border: none; pointer-events: none; }
  .main-dpad .dpad-btn.home   { font-size: 0.5rem; letter-spacing: 0.5px; color: rgba(255,255,255,0.4); font-family: 'Share Tech Mono',monospace; }
  .main-dpad .dpad-btn.home:hover { color: #fff; background: rgba(255,255,255,0.12); }

  .username-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .username-display {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    color: var(--white);
    background: var(--faint);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 14px;
    letter-spacing: 1px;
  }

  .username-tag {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.3);
    letter-spacing: 1px;
    font-family: 'Share Tech Mono', monospace;
  }

  .chat-window {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 10px;
    height: 320px;
    overflow-y: auto;
    padding: 16px;
    margin-bottom: 14px;
    scroll-behavior: smooth;
  }
  .chat-window::-webkit-scrollbar { width: 4px; }
  .chat-window::-webkit-scrollbar-track { background: transparent; }
  .chat-window::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

  .chat-msg {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.83rem;
    line-height: 1.6;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .chat-msg:last-child { border-bottom: none; }
  .chat-msg .ts { color: rgba(255,255,255,0.2); font-size: 0.72rem; margin-right: 6px; }
  .chat-msg .user { color: #fff; font-weight: bold; margin-right: 6px; }
  .chat-msg .text { color: rgba(255,255,255,0.8); }
  .chat-msg.system .text { color: rgba(255,255,255,0.3); font-style: italic; }

  .chat-input-row { display: flex; gap: 10px; }

  .chat-input {
    flex: 1;
    background: var(--faint);
    border: 1px solid var(--border);
    color: #fff;
    border-radius: 8px;
    padding: 10px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.88rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: rgba(255,255,255,0.45); }
  .chat-input::placeholder { color: rgba(255,255,255,0.2); }

  .chat-send-btn {
    background: #fff;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 10px 22px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .chat-send-btn:hover { background: rgba(255,255,255,0.85); transform: scale(1.03); }

  /* Modals */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(6px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.hidden { display: none; }

  .modal-box {
    background: #0a0a0a;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 14px;
    padding: 36px 32px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 0 60px rgba(255,255,255,0.08);
  }

  .modal-title { font-size: 1.1rem; letter-spacing: 3px; margin-bottom: 8px; }
  .modal-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    color: var(--dim);
    margin-bottom: 24px;
    letter-spacing: 1px;
    line-height: 1.6;
  }

  .modal-input {
    width: 100%;
    background: var(--faint);
    border: 1px solid var(--border);
    color: #fff;
    border-radius: 8px;
    padding: 11px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    outline: none;
    margin-bottom: 12px;
    transition: border-color 0.2s;
  }
  .modal-input:focus { border-color: rgba(255,255,255,0.45); }
  .modal-input::placeholder { color: rgba(255,255,255,0.2); }

  .modal-error {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    color: #ff6b6b;
    margin-bottom: 12px;
    min-height: 18px;
    letter-spacing: 1px;
  }

  .modal-btn-row { display: flex; gap: 10px; flex-wrap: wrap; }

  .modal-btn {
    flex: 1;
    background: none;
    border: 1px solid var(--border);
    color: #fff;
    padding: 10px 16px;
    border-radius: 8px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .modal-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); }
  .modal-btn.primary { background: #fff; color: #000; border-color: #fff; }
  .modal-btn.primary:hover { background: rgba(255,255,255,0.88); }

  #pwStep { display: none; }

  /* ToS Modal */
  #tosModal .modal-box { max-width: 520px; }

  .tos-link {
    color: #fff;
    text-decoration: underline;
    text-decoration-style: dotted;
    cursor: pointer;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.95rem;
    letter-spacing: 1px;
    transition: opacity 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .tos-link:hover { opacity: 0.7; }
  .tos-link::after { content: ' ↗'; font-size: 0.8rem; opacity: 0.6; }

  .tos-agree-btn {
    width: 100%;
    margin-top: 20px;
    background: #fff;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 13px 20px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .tos-agree-btn:hover { background: rgba(255,255,255,0.88); transform: scale(1.02); }

  .tos-decline-btn {
    width: 100%;
    margin-top: 10px;
    background: none;
    color: rgba(255,255,255,0.35);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 10px 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .tos-decline-btn:hover { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.25); }

  #tosPopup {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    backdrop-filter: blur(8px);
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  #tosPopup.hidden { display: none; }

  .tos-popup-box {
    background: #0a0a0a;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 14px;
    padding: 36px 32px;
    width: 100%;
    max-width: 640px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 60px rgba(255,255,255,0.08);
  }
  .tos-popup-box::-webkit-scrollbar { width: 4px; }
  .tos-popup-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

  .tos-popup-title { font-size: 1rem; letter-spacing: 3px; margin-bottom: 4px; }
  .tos-popup-date {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    color: rgba(255,255,255,0.3);
    letter-spacing: 2px;
    margin-bottom: 24px;
  }
  .tos-popup-body {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    line-height: 1.8;
    color: rgba(255,255,255,0.75);
  }
  .tos-popup-body h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.78rem;
    color: #fff;
    letter-spacing: 2px;
    margin: 20px 0 8px;
  }
  .tos-popup-body ul { padding-left: 18px; margin: 6px 0; }
  .tos-popup-body li { margin-bottom: 6px; }

  .tos-close-btn {
    margin-top: 28px;
    background: none;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.6);
    border-radius: 8px;
    padding: 10px 24px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .tos-close-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }

  #canvasLock {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.4);
    letter-spacing: 2px;
    border-radius: 10px;
  }
  #canvasLock.hidden { display: none; }

  /* ── EXPAND BUTTON ── */
  .expand-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.35);
    color: #fff;
    padding: 7px 14px;
    border-radius: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
    margin-left: auto;
  }
  .expand-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); box-shadow: 0 0 12px rgba(255,255,255,0.15); }

  /* ── EXPANDED OVERLAY ── */
  #expandedOverlay {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 4000;
    display: flex;
    flex-direction: column;
  }
  #expandedOverlay.hidden { display: none; }

  .exp-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: rgba(0,0,0,0.95);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .exp-close {
    background: none;
    border: 1px solid rgba(255,80,80,0.5);
    color: rgba(255,120,120,0.9);
    padding: 7px 16px;
    border-radius: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
    margin-left: auto;
  }
  .exp-close:hover { background: rgba(255,60,60,0.15); border-color: rgba(255,100,100,0.9); }

  #expViewport {
    flex: 1;
    overflow: hidden;
    position: relative;
    background: #111;
  }

  #expWrap {
    position: absolute;
    top: 0; left: 0;
    transform-origin: top left;
    cursor: crosshair;
    line-height: 0;
  }

  #expCanvas {
    display: block;
    image-rendering: pixelated;
  }

  .dpad {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: grid;
    grid-template-columns: repeat(3, 44px);
    grid-template-rows: repeat(3, 44px);
    gap: 3px;
    z-index: 10;
  }

  .dpad-btn {
    background: rgba(0,0,0,0.8);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 7px;
    font-size: 1.05rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    user-select: none;
    -webkit-user-select: none;
  }
  .dpad-btn:hover  { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.5); }
  .dpad-btn:active { background: rgba(255,255,255,0.28); transform: scale(0.92); }
  .dpad-btn.empty  { background: none; border: none; pointer-events: none; }
  .dpad-btn.home   { font-size: 0.58rem; letter-spacing: 0.5px; color: rgba(255,255,255,0.4); font-family: 'Share Tech Mono',monospace; }
  .dpad-btn.home:hover { color: #fff; background: rgba(255,255,255,0.12); }

  .exp-coords {
    position: absolute;
    bottom: 22px;
    left: 18px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.68rem;
    color: rgba(255,255,255,0.2);
    letter-spacing: 1px;
    pointer-events: none;
  }

  @media (max-width: 600px) {
    .page-title { font-size: 1.8rem; }
    .canvas-toolbar { gap: 6px; }
  }
</style>
{% endblock %}

{% block body %}

<!-- ToS Full Popup -->
<div id="tosPopup" class="hidden">
  <div class="tos-popup-box">
    <div class="tos-popup-title">TERMS OF SERVICE: "THE WALL"</div>
    <div class="tos-popup-date">Last Updated: February 22, 2026</div>
    <div class="tos-popup-body">
      <p>Welcome to The Wall at fliphouserecords.com. By clicking "I Agree" or by accessing and using this page, you are entering into a legally binding agreement. If you don't agree to these terms, please head back to the main site.</p>
      <h3>1. COMMUNITY CONDUCT (THE "DON'T BE A JERK" POLICY)</h3>
      <p>"The Wall" is a shared creative space. To keep it functional and fun, you agree not to:</p>
      <ul>
        <li>Post or draw anything illegal, pornographic, or sexually explicit.</li>
        <li>Engage in hate speech, harassment, or threats against individuals or groups.</li>
        <li>Post "Doxxing" information (phone numbers, home addresses, or private data).</li>
        <li>Use bots or scripts to automate drawing or spam the chat room.</li>
      </ul>
      <h3>2. USER-GENERATED CONTENT & LICENSING</h3>
      <p>You own what you create, but because this is a public, shared experience, you grant Flip House Records a non-exclusive, royalty-free, worldwide license to display, record, and share snapshots of "The Wall" (including your contributions) for promotional or archival purposes.</p>
      <h3>3. MODERATION & "THE RIGHT TO ERASE"</h3>
      <p>We don't pre-screen content, but we reserve the right to:</p>
      <ul>
        <li>Wipe the canvas at any time (The "Big Reset").</li>
        <li>Delete specific drawings or chat messages that violate these terms.</li>
        <li>Ban IP addresses or users who repeatedly disrupt the experience.</li>
      </ul>
      <h3>4. DISCLAIMER OF LIABILITY</h3>
      <p>The Wall is provided "As-Is." Flip House Records is not responsible for the content created by users. You understand that you may be exposed to content that is offensive, indecent, or objectionable. We are not liable for any emotional distress, data loss, or technical "glitches" that occur while using this experimental tool.</p>
      <h3>5. AGE REQUIREMENT</h3>
      <p>By using The Wall, you represent that you are at least 13 years of age. If you are under 18, you represent that you have parental permission to be here.</p>
      <h3>6. PRIVACY NOTE</h3>
      <p>We may log IP addresses to prevent abuse and spam. We do not sell your data, but we will cooperate with law enforcement if illegal activity is detected on the platform.</p>
    </div>
    <button class="tos-close-btn" onclick="closeTosPopup()">← CLOSE</button>
  </div>
</div>

<!-- ToS Agreement Modal -->
<div class="modal-overlay" id="tosModal">
  <div class="modal-box">
    <div class="modal-title">BEFORE YOU ENTER</div>
    <div class="modal-sub">
      This is a shared public space. By continuing, you agree to the rules.<br><br>
      <span class="tos-link" onclick="openTosPopup()">Terms of Service: "The Wall"</span>
      <br><small style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:rgba(255,255,255,0.3);letter-spacing:1px;margin-top:6px;display:block;">↑ click to read the full terms in a new window</small>
    </div>
    <button class="tos-agree-btn" onclick="agreeTos()">I HAVE READ THE TERMS AND I PROMISE TO BE COOL</button>
    <button class="tos-decline-btn" onclick="location.href='/'">No thanks, take me back</button>
  </div>
</div>

<!-- Username Modal -->
<div class="modal-overlay hidden" id="usernameModal">
  <div class="modal-box">
    <div class="modal-title">ENTER THE WALL</div>
    <div class="modal-sub" id="modalSub">
      Type a username or leave blank for a random one.<br>
      Reserved names require a password.
    </div>
    <div id="nameStep">
      <input class="modal-input" type="text" id="usernameInput" placeholder="username (optional)" maxlength="50" autocomplete="off">
      <div class="modal-error" id="modalError"></div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="randomBtn">RANDOM NAME</button>
        <button class="modal-btn primary" id="enterBtn">ENTER</button>
      </div>
    </div>
    <div id="pwStep">
      <div style="font-family:'Share Tech Mono',monospace;font-size:0.82rem;color:var(--dim);margin-bottom:14px;" id="pwLabel"></div>
      <input class="modal-input" type="password" id="passwordInput" placeholder="password" maxlength="100" autocomplete="off">
      <div class="modal-error" id="pwError"></div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="pwBackBtn">BACK</button>
        <button class="modal-btn primary" id="pwSubmitBtn">CONFIRM</button>
        <button class="modal-btn" id="reserveBtn" style="display:none;">RESERVE NAME</button>
      </div>
    </div>
  </div>
</div>

<!-- Expanded Canvas Overlay -->
<div id="expandedOverlay" class="hidden">
  <div class="exp-toolbar">
    <button class="tool-btn active" id="expBtnDraw" onclick="expSetTool('draw')">✏ DRAW</button>
    <button class="tool-btn" id="expBtnErase" onclick="expSetTool('erase')">◻ ERASE</button>
    <button class="tool-btn" id="expBtnFill" onclick="expSetTool('fill')">⬛ FILL</button>
    <div class="size-slider-wrap">
      <span>SIZE</span>
      <input type="range" id="expBrushSize" min="1" max="20" value="3">
      <span id="expSizeLabel">3</span>
    </div>
    <div id="expPalette" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;"></div>
    <input type="color" id="expColorPicker" value="#ffffff" title="Custom color" style="width:32px;height:32px;border:2px solid var(--border);border-radius:50%;cursor:pointer;background:none;padding:0;">
    <button class="tool-btn" onclick="confirmClear()" style="border-color:rgba(255,80,80,0.5);color:rgba(255,100,100,0.9)">✕ CLEAR ALL</button>
    <button class="exp-close" onclick="closeExpanded()">✕ CLOSE</button>
  </div>
  <div id="expViewport">
    <div id="expWrap">
      <canvas id="expCanvas"></canvas>
    </div>
    <!-- D-pad: 3x3 grid, corners empty -->
    <div class="dpad">
      <div class="dpad-btn empty"></div>
      <div class="dpad-btn" id="dUp">▲</div>
      <div class="dpad-btn empty"></div>
      <div class="dpad-btn" id="dLeft">◀</div>
      <div class="dpad-btn home" id="dHome">HOME</div>
      <div class="dpad-btn" id="dRight">▶</div>
      <div class="dpad-btn empty"></div>
      <div class="dpad-btn" id="dDown">▼</div>
      <div class="dpad-btn empty"></div>
    </div>
    <div class="exp-coords" id="expCoords">x:0  y:0</div>
  </div>
</div>

<!-- Main Content -->
<div class="page-wrap">
  <h1 class="page-title">THE WALL</h1>
  <p class="page-sub">// LEAVE YOUR MARK //</p>

  <div class="canvas-section">
    <div class="section-header">PAINT — shared canvas, see what the Central Valley has to say.</div>
    <div class="canvas-toolbar">
      <button class="tool-btn active" id="btnDraw" onclick="setTool('draw')">✏ DRAW</button>
      <button class="tool-btn" id="btnErase" onclick="setTool('erase')">◻ ERASE</button>
      <button class="tool-btn" id="btnFill" onclick="setTool('fill')">⬛ FILL</button>
      <div class="size-slider-wrap">
        <span>SIZE</span>
        <input type="range" id="brushSize" min="1" max="20" value="3">
        <span id="sizeLabel">3</span>
      </div>
      <div id="palette" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;"></div>
      <input type="color" id="colorPicker" value="#ffffff" title="Custom color">
      <button class="tool-btn" id="btnClear" onclick="confirmClear()" style="margin-left:auto;border-color:rgba(255,80,80,0.5);color:rgba(255,100,100,0.9)">✕ CLEAR ALL</button>
      <button class="expand-btn" onclick="openExpanded()">⛶ EXPAND</button>
    </div>
    <div class="canvas-outer" id="canvasOuter" style="overflow:hidden;">
      <div id="mainWrap" style="position:absolute;top:0;left:0;transform-origin:top left;will-change:transform;">
        <canvas id="wallCanvas"></canvas>
      </div>
      <div id="canvasLock">// AGREE TO TERMS TO UNLOCK //</div>
      <!-- Main canvas D-pad -->
      <div class="main-dpad">
        <div class="dpad-btn empty"></div>
        <div class="dpad-btn" id="mUp">▲</div>
        <div class="dpad-btn empty"></div>
        <div class="dpad-btn" id="mLeft">◀</div>
        <div class="dpad-btn home" id="mHome">HOME</div>
        <div class="dpad-btn" id="mRight">▶</div>
        <div class="dpad-btn empty"></div>
        <div class="dpad-btn" id="mDown">▼</div>
        <div class="dpad-btn empty"></div>
      </div>
    </div>
    <div class="canvas-status" id="canvasStatus">connecting…</div>
  </div>

  <div class="chat-section">
    <div class="section-header">CHAT — anonymous, real-time</div>
    <div class="username-bar">
      <span class="username-tag">CHATTING AS</span>
      <span class="username-display" id="usernameTag">—</span>
      <button class="tool-btn" onclick="openUsernameModal()" style="font-size:0.75rem;padding:6px 12px;">CHANGE</button>
    </div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-msg system"><span class="text">// loading messages…</span></div>
    </div>
    <div class="chat-input-row">
      <input class="chat-input" type="text" id="chatInput" placeholder="say something…" maxlength="500" autocomplete="off">
      <button class="chat-send-btn" onclick="sendChat()">SEND</button>
    </div>
  </div>
</div>

<footer class="footer">&copy; 2025 Flip House Records</footer>

{% endblock %}

{% block extra_js %}
<script>
const COLS = 160, ROWS = 90;
const canvas = document.getElementById('wallCanvas');
const ctx = canvas.getContext('2d');
canvas.width = COLS;
canvas.height = ROWS;

const outer = document.getElementById('canvasOuter');
const mainWrap = document.getElementById('mainWrap');

// Main canvas pan state
let mainPanX = 0, mainPanY = 0;
const MAIN_PAN_STEP = 80;

function resizeCanvas() {
  const w = outer.offsetWidth;
  const h = Math.round(w * ROWS / COLS);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  // set outer to fixed height so overflow:hidden works
  outer.style.height = h + 'px';
  clampMainPan();
  applyMainPan();
}

function clampMainPan() {
  const canvasW = parseFloat(canvas.style.width) || outer.offsetWidth;
  const canvasH = parseFloat(canvas.style.height) || outer.offsetHeight;
  mainPanX = Math.max(0, Math.min(mainPanX, Math.max(0, canvasW - outer.offsetWidth)));
  mainPanY = Math.max(0, Math.min(mainPanY, Math.max(0, canvasH - outer.offsetHeight)));
}

function applyMainPan() {
  mainWrap.style.transform = `translate(${-mainPanX}px,${-mainPanY}px)`;
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Main canvas D-pad
document.getElementById('mUp').addEventListener('click',    () => { mainPanY -= MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mDown').addEventListener('click',  () => { mainPanY += MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mLeft').addEventListener('click',  () => { mainPanX -= MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mRight').addEventListener('click', () => { mainPanX += MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mHome').addEventListener('click',  () => { mainPanX = 0; mainPanY = 0; applyMainPan(); });

let pixelData = {};

function renderAll() {
  ctx.clearRect(0, 0, COLS, ROWS);
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, COLS, ROWS);
  for (const [key, color] of Object.entries(pixelData)) {
    const [x, y] = key.split(',').map(Number);
    ctx.fillStyle = color;
    ctx.fillRect(x, y, 1, 1);
  }
}

function applyPixels(pixels) {
  for (const p of pixels) {
    const key = `${p.x},${p.y}`;
    if (p.color === 'erase') delete pixelData[key];
    else pixelData[key] = p.color;
  }
  for (const p of pixels) {
    ctx.fillStyle = p.color === 'erase' ? '#111' : p.color;
    ctx.fillRect(p.x, p.y, 1, 1);
  }
}

let currentTool = 'draw';
let currentColor = '#ffffff';
let brushSz = 3;
let isDrawing = false;
let pendingPixels = [];
let flushTimer = null;

function setTool(t) {
  currentTool = t;
  document.querySelectorAll('.tool-btn[id^="btn"]').forEach(b => b.classList.remove('active'));
  const m = { draw: 'btnDraw', erase: 'btnErase', fill: 'btnFill' };
  if (m[t]) document.getElementById(m[t]).classList.add('active');
  canvas.style.cursor = t === 'erase' ? 'cell' : 'crosshair';
}

const PALETTE = ['#ffffff','#ff4444','#ff8c00','#ffd700','#44ff88','#00cfff','#7b61ff','#ff61d8','#000000','#555555','#c0a060','#1a1a2e'];
const paletteEl = document.getElementById('palette');
PALETTE.forEach(hex => {
  const s = document.createElement('div');
  s.className = 'color-swatch' + (hex === currentColor ? ' selected' : '');
  s.style.background = hex;
  s.title = hex;
  s.addEventListener('click', () => selectColor(hex, s));
  paletteEl.appendChild(s);
});

function selectColor(hex, el) {
  currentColor = hex;
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
  if (el) el.classList.add('selected');
  setTool('draw');
}

document.getElementById('colorPicker').addEventListener('input', e => {
  selectColor(e.target.value, null);
  setTool('draw');
});

document.getElementById('brushSize').addEventListener('input', e => {
  brushSz = parseInt(e.target.value);
  document.getElementById('sizeLabel').textContent = brushSz;
});

function getCellFromEvent(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = COLS / rect.width;
  const scaleY = ROWS / rect.height;
  let clientX, clientY;
  if (e.touches) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  // account for pan offset so drawing stays aligned
  return {
    x: Math.max(0, Math.min(COLS-1, Math.floor((clientX - rect.left + mainPanX) * scaleX))),
    y: Math.max(0, Math.min(ROWS-1, Math.floor((clientY - rect.top  + mainPanY) * scaleY))),
  };
}

function paintAt(x, y) {
  const half = Math.floor(brushSz / 2);
  const batch = [];
  if (currentTool === 'fill') {
    const target = pixelData[`${x},${y}`] || null;
    if (target === currentColor) return;
    const stack = [[x, y]];
    const visited = new Set();
    while (stack.length) {
      const [cx, cy] = stack.pop();
      if (cx < 0 || cy < 0 || cx >= COLS || cy >= ROWS) continue;
      const k = `${cx},${cy}`;
      if (visited.has(k)) continue;
      const cur = pixelData[k] || null;
      if (cur !== target) continue;
      visited.add(k);
      batch.push({ x: cx, y: cy, color: currentColor });
      stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
    }
  } else {
    for (let dx = -half; dx <= half; dx++) {
      for (let dy = -half; dy <= half; dy++) {
        const px = x + dx, py = y + dy;
        if (px < 0 || py < 0 || px >= COLS || py >= ROWS) continue;
        batch.push({ x: px, y: py, color: currentTool === 'erase' ? 'erase' : currentColor });
      }
    }
  }
  if (batch.length) {
    applyPixels(batch);
    pendingPixels.push(...batch);
    scheduleFlush();
  }
}

function scheduleFlush() {
  if (flushTimer) return;
  flushTimer = setTimeout(() => {
    if (pendingPixels.length && canvasWS && canvasWS.readyState === WebSocket.OPEN) {
      canvasWS.send(JSON.stringify({ type: 'draw', pixels: pendingPixels }));
    }
    pendingPixels = [];
    flushTimer = null;
  }, 50);
}

canvas.addEventListener('mousedown', e => { isDrawing = true; const c = getCellFromEvent(e); paintAt(c.x, c.y); });
canvas.addEventListener('mousemove', e => { if (!isDrawing) return; const c = getCellFromEvent(e); paintAt(c.x, c.y); });
canvas.addEventListener('mouseup', () => { isDrawing = false; });
canvas.addEventListener('mouseleave', () => { isDrawing = false; });
canvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing = true; const c = getCellFromEvent(e); paintAt(c.x, c.y); }, { passive: false });
canvas.addEventListener('touchmove', e => { e.preventDefault(); if (!isDrawing) return; const c = getCellFromEvent(e); paintAt(c.x, c.y); }, { passive: false });
canvas.addEventListener('touchend', () => { isDrawing = false; });

function confirmClear() {
  if (confirm('Clear the entire wall? This affects everyone.')) {
    if (canvasWS && canvasWS.readyState === WebSocket.OPEN) {
      canvasWS.send(JSON.stringify({ type: 'clear' }));
    }
  }
}

let canvasWS;
const canvasStatus = document.getElementById('canvasStatus');

function connectCanvas() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  canvasWS = new WebSocket(`${proto}://${location.host}/ws/canvas/`);
  canvasWS.onopen = () => {
    canvasStatus.textContent = '● connected';
    canvasStatus.style.color = 'rgba(100,255,150,0.6)';
  };
  canvasWS.onclose = () => {
    canvasStatus.textContent = '○ disconnected — retrying…';
    canvasStatus.style.color = 'rgba(255,100,100,0.5)';
    setTimeout(connectCanvas, 3000);
  };
  canvasWS.onerror = () => { canvasStatus.textContent = '○ connection error'; };
  canvasWS.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'canvas_init') { pixelData = msg.data || {}; renderAll(); }
    else if (msg.type === 'draw') { applyPixels(msg.pixels); }
    else if (msg.type === 'clear') { pixelData = {}; renderAll(); }
  };
}

connectCanvas();
renderAll();

let chatWS;
let myUsername = null;
const chatWindow = document.getElementById('chatWindow');
const HISTORY = {{ messages_json|safe }};

function connectChat() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  chatWS = new WebSocket(`${proto}://${location.host}/ws/chat/`);
  chatWS.onopen = () => {};
  chatWS.onclose = () => { setTimeout(connectChat, 3000); };
  chatWS.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'message') { appendMessage(msg.username, msg.message, msg.timestamp, false); }
    else if (msg.type === 'username_status') { handleUsernameStatus(msg); }
    else if (msg.type === 'reserve_result') { handleReserveResult(msg); }
    else if (msg.type === 'auth_result') { handleAuthResult(msg); }
  };
}

connectChat();

function appendMessage(username, message, ts, isSystem) {
  const div = document.createElement('div');
  div.className = 'chat-msg' + (isSystem ? ' system' : '');
  if (isSystem) {
    div.innerHTML = `<span class="text">${escapeHtml(message)}</span>`;
  } else {
    div.innerHTML = `<span class="ts">[${ts}]</span><span class="user">${escapeHtml(username)}:</span><span class="text">${escapeHtml(message)}</span>`;
  }
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

chatWindow.innerHTML = '';
if (HISTORY.length === 0) {
  appendMessage('', '// no messages yet — be the first //', '', true);
} else {
  for (const m of HISTORY) appendMessage(m.username, m.message, m.timestamp, false);
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !myUsername) return;
  if (!chatWS || chatWS.readyState !== WebSocket.OPEN) return;
  chatWS.send(JSON.stringify({ type: 'chat_message', username: myUsername, message: text }));
  input.value = '';
}

document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendChat();
});

const modal = document.getElementById('usernameModal');
let pendingUsername = null;

function generateRandomName() {
  const adj = ['cosmic','dusty','frozen','neon','glitch','vapor','turbo','indie','lunar','wired'];
  const noun = ['bass','beat','flip','groove','sample','scratch','synth','vinyl','wave','zone'];
  return `${adj[Math.floor(Math.random()*adj.length)]}-${noun[Math.floor(Math.random()*noun.length)]}-${Math.floor(Math.random()*90)+10}`;
}

document.getElementById('randomBtn').addEventListener('click', () => {
  document.getElementById('usernameInput').value = generateRandomName();
});

document.getElementById('enterBtn').addEventListener('click', () => {
  let name = document.getElementById('usernameInput').value.trim();
  if (!name) name = generateRandomName();
  pendingUsername = name;
  if (!chatWS || chatWS.readyState !== WebSocket.OPEN) { finalizeUsername(name); return; }
  chatWS.send(JSON.stringify({ type: 'check_username', username: name }));
});

document.getElementById('usernameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('enterBtn').click();
});

function handleUsernameStatus(msg) {
  if (!msg.taken) {
    showPwStep(`"${msg.username}" is available. Set a password to reserve it, or skip.`, false);
  } else {
    showPwStep(`"${msg.username}" is reserved. Enter the password to use it.`, true);
  }
}

function showPwStep(label, isLogin) {
  document.getElementById('nameStep').style.display = 'none';
  document.getElementById('pwStep').style.display = 'block';
  document.getElementById('pwLabel').textContent = label;
  document.getElementById('passwordInput').value = '';
  document.getElementById('pwError').textContent = '';
  const reserveBtn = document.getElementById('reserveBtn');
  const submitBtn = document.getElementById('pwSubmitBtn');
  if (isLogin) {
    submitBtn.textContent = 'LOGIN';
    reserveBtn.style.display = 'none';
  } else {
    submitBtn.textContent = 'SKIP';
    reserveBtn.style.display = 'block';
    reserveBtn.textContent = 'RESERVE NAME';
  }
}

document.getElementById('pwBackBtn').addEventListener('click', () => {
  document.getElementById('nameStep').style.display = 'block';
  document.getElementById('pwStep').style.display = 'none';
  document.getElementById('modalError').textContent = '';
});

document.getElementById('pwSubmitBtn').addEventListener('click', () => {
  const pw = document.getElementById('passwordInput').value;
  if (document.getElementById('pwSubmitBtn').textContent === 'LOGIN') {
    chatWS.send(JSON.stringify({ type: 'auth_username', username: pendingUsername, password: pw }));
  } else {
    finalizeUsername(pendingUsername);
  }
});

document.getElementById('reserveBtn').addEventListener('click', () => {
  const pw = document.getElementById('passwordInput').value;
  if (!pw) { document.getElementById('pwError').textContent = 'Enter a password to reserve.'; return; }
  chatWS.send(JSON.stringify({ type: 'reserve_username', username: pendingUsername, password: pw }));
});

function handleReserveResult(msg) {
  if (msg.success) { finalizeUsername(pendingUsername); }
  else { document.getElementById('pwError').textContent = msg.error || 'Error.'; }
}

function handleAuthResult(msg) {
  if (msg.success) { finalizeUsername(pendingUsername); }
  else { document.getElementById('pwError').textContent = msg.error || 'Wrong password.'; }
}

function finalizeUsername(name) {
  myUsername = name;
  document.getElementById('usernameTag').textContent = name;
  modal.classList.add('hidden');
  appendMessage('', `// you joined as ${name} //`, '', true);
}

function openUsernameModal() {
  modal.classList.remove('hidden');
  document.getElementById('nameStep').style.display = 'block';
  document.getElementById('pwStep').style.display = 'none';
  document.getElementById('usernameInput').value = myUsername || '';
  document.getElementById('modalError').textContent = '';
}

// ToS
const tosModal = document.getElementById('tosModal');
const tosPopup = document.getElementById('tosPopup');
let tosAgreed = false;

function openTosPopup() { tosPopup.classList.remove('hidden'); }
function closeTosPopup() { tosPopup.classList.add('hidden'); }

function agreeTos() {
  tosAgreed = true;
  sessionStorage.setItem('wall_tos_agreed', '1');
  tosModal.classList.add('hidden');
  document.getElementById('canvasLock').classList.add('hidden');
  openUsernameModal();
}

window.addEventListener('load', () => {
  if (sessionStorage.getItem('wall_tos_agreed') === '1') {
    tosAgreed = true;
    tosModal.classList.add('hidden');
    document.getElementById('canvasLock').classList.add('hidden');
    openUsernameModal();
  } else {
    tosModal.classList.remove('hidden');
  }
});

// ═══════════════════════════════════════════════════
// EXPANDED CANVAS  (4x pixel size, pannable viewport)
// ═══════════════════════════════════════════════════
const SCALE = 4;  // each 160x90 pixel becomes a 4x4 block
const expCanvas  = document.getElementById('expCanvas');
const expCtx     = expCanvas.getContext('2d');
const expWrap    = document.getElementById('expWrap');
const expViewport= document.getElementById('expViewport');
const expCoords  = document.getElementById('expCoords');

expCanvas.width  = COLS * SCALE;   // 640
expCanvas.height = ROWS * SCALE;   // 360
expCanvas.style.width  = (COLS * SCALE) + 'px';
expCanvas.style.height = (ROWS * SCALE) + 'px';

let panX = 0, panY = 0;
const PAN_STEP = 100;

function clampPan() {
  const maxX = Math.max(0, COLS * SCALE - expViewport.offsetWidth);
  const maxY = Math.max(0, ROWS * SCALE - expViewport.offsetHeight);
  panX = Math.max(0, Math.min(panX, maxX));
  panY = Math.max(0, Math.min(panY, maxY));
}

function applyExpPan() {
  clampPan();
  expWrap.style.transform = `translate(${-panX}px,${-panY}px)`;
  expCoords.textContent = `x:${Math.round(panX/SCALE)}  y:${Math.round(panY/SCALE)}`;
}

function renderExpanded() {
  expCtx.fillStyle = '#111';
  expCtx.fillRect(0, 0, COLS * SCALE, ROWS * SCALE);
  for (const [key, color] of Object.entries(pixelData)) {
    const [x, y] = key.split(',').map(Number);
    expCtx.fillStyle = color;
    expCtx.fillRect(x * SCALE, y * SCALE, SCALE, SCALE);
  }
}

// Also update expanded canvas when pixels arrive from WS
const _origApplyPixels = applyPixels;
applyPixels = function(pixels) {
  _origApplyPixels(pixels);
  if (!document.getElementById('expandedOverlay').classList.contains('hidden')) {
    for (const p of pixels) {
      expCtx.fillStyle = p.color === 'erase' ? '#111' : p.color;
      expCtx.fillRect(p.x * SCALE, p.y * SCALE, SCALE, SCALE);
    }
  }
};

// Drawing on expanded canvas maps back to same 160x90 grid
function getExpCell(e) {
  const rect = expCanvas.getBoundingClientRect();
  let cx, cy;
  if (e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
  else           { cx = e.clientX;             cy = e.clientY; }
  return {
    x: Math.max(0, Math.min(COLS-1, Math.floor((cx - rect.left) / SCALE))),
    y: Math.max(0, Math.min(ROWS-1, Math.floor((cy - rect.top)  / SCALE))),
  };
}

let expDrawing = false;
expCanvas.addEventListener('mousedown', e => {
  expDrawing = true;
  const c = getExpCell(e); paintAt(c.x, c.y); renderExpanded();
});
expCanvas.addEventListener('mousemove', e => {
  if (!expDrawing) return;
  const c = getExpCell(e); paintAt(c.x, c.y); renderExpanded();
});
expCanvas.addEventListener('mouseup',    () => { expDrawing = false; });
expCanvas.addEventListener('mouseleave', () => { expDrawing = false; });
expCanvas.addEventListener('touchstart', e => { e.preventDefault(); expDrawing = true;  const c = getExpCell(e); paintAt(c.x,c.y); renderExpanded(); }, { passive:false });
expCanvas.addEventListener('touchmove',  e => { e.preventDefault(); if (!expDrawing) return; const c = getExpCell(e); paintAt(c.x,c.y); renderExpanded(); }, { passive:false });
expCanvas.addEventListener('touchend',   () => { expDrawing = false; });

// D-pad buttons
document.getElementById('dUp').addEventListener('click',    () => { panY -= PAN_STEP; applyExpPan(); });
document.getElementById('dDown').addEventListener('click',  () => { panY += PAN_STEP; applyExpPan(); });
document.getElementById('dLeft').addEventListener('click',  () => { panX -= PAN_STEP; applyExpPan(); });
document.getElementById('dRight').addEventListener('click', () => { panX += PAN_STEP; applyExpPan(); });
document.getElementById('dHome').addEventListener('click',  () => { panX = 0; panY = 0; applyExpPan(); });

// Keyboard arrows when expanded
window.addEventListener('keydown', e => {
  if (document.getElementById('expandedOverlay').classList.contains('hidden')) return;
  if (e.key === 'ArrowUp')    { panY -= PAN_STEP; applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowDown')  { panY += PAN_STEP; applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowLeft')  { panX -= PAN_STEP; applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowRight') { panX += PAN_STEP; applyExpPan(); e.preventDefault(); }
  if (e.key === 'Escape')     { closeExpanded(); }
});

// Expanded toolbar — mirrors main toolbar, shares currentTool/currentColor/brushSz
function expSetTool(t) {
  setTool(t);
  document.querySelectorAll('#expandedOverlay .tool-btn[id^="expBtn"]').forEach(b => b.classList.remove('active'));
  const map = { draw:'expBtnDraw', erase:'expBtnErase', fill:'expBtnFill' };
  if (map[t]) document.getElementById(map[t]).classList.add('active');
  expCanvas.style.cursor = t === 'erase' ? 'cell' : 'crosshair';
}

// Build expanded palette
const expPaletteEl = document.getElementById('expPalette');
PALETTE.forEach(hex => {
  const s = document.createElement('div');
  s.className = 'color-swatch' + (hex === currentColor ? ' selected' : '');
  s.style.background = hex;
  s.title = hex;
  s.addEventListener('click', () => {
    selectColor(hex, s);
    expSetTool('draw');
  });
  expPaletteEl.appendChild(s);
});

document.getElementById('expColorPicker').addEventListener('input', e => {
  selectColor(e.target.value, null);
  expSetTool('draw');
});

document.getElementById('expBrushSize').addEventListener('input', e => {
  brushSz = parseInt(e.target.value);
  document.getElementById('expSizeLabel').textContent = brushSz;
  document.getElementById('brushSize').value = Math.min(brushSz, 20);
  document.getElementById('sizeLabel').textContent = brushSz;
});

function openExpanded() {
  panX = 0; panY = 0;
  document.getElementById('expandedOverlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  renderExpanded();
  applyExpPan();
  // sync tool state
  expSetTool(currentTool);
  document.getElementById('expBrushSize').value = brushSz;
  document.getElementById('expSizeLabel').textContent = brushSz;
}

function closeExpanded() {
  document.getElementById('expandedOverlay').classList.add('hidden');
  document.body.style.overflow = '';
  renderAll(); // keep main canvas in sync
}
</script>
{% endblock %}
