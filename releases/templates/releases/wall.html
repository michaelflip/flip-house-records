{% extends "base.html" %}
{% load static %}

{% block title %}Flip House Records - The Wall{% endblock %}

{% block extra_css %}
<style>
  :root {
    --white: #ffffff;
    --dim: rgba(255,255,255,0.5);
    --faint: rgba(255,255,255,0.08);
    --border: rgba(255,255,255,0.15);
  }

  .page-wrap { max-width: 1100px; margin: 0 auto; padding: 110px 16px 80px; }

  .page-title { text-align: center; font-size: 2.6rem; letter-spacing: 5px; margin-bottom: 6px; text-shadow: 0 0 30px rgba(255,255,255,0.4); }
  .page-sub { text-align: center; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--dim); letter-spacing: 3px; margin-bottom: 50px; }

  .section-header { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; letter-spacing: 4px; color: rgba(255,255,255,0.35); text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 22px; }

  .canvas-section { margin-bottom: 60px; }
  .canvas-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 20px; }

  .tool-group-vertical { display: flex; flex-direction: column; gap: 4px; }
  .tool-btn { background: var(--faint); border: 1px solid var(--border); color: #fff; padding: 7px 16px; border-radius: 6px; font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; height: 100%; display: flex; align-items: center; justify-content: center; }
  .tool-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
  .tool-btn.active { background: #fff; color: #000; border-color: #fff; }
  .tool-btn.sub-btn { font-size: 0.65rem; padding: 4px 8px; line-height: 1; }

  .size-slider-wrap { display: flex; align-items: center; gap: 8px; font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; color: var(--dim); margin-left: 8px; }
  #brushSize { width: 80px; accent-color: #fff; }

  .color-swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.15s, border-color 0.15s; flex-shrink: 0; }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.selected { border-color: #fff; transform: scale(1.2); }
  #colorPicker { width: 32px; height: 32px; border: 2px solid var(--border); border-radius: 50%; cursor: pointer; background: none; padding: 0; }

  .canvas-outer { position: relative; border: 2px solid var(--border); border-radius: 10px; overflow: hidden; background: #111; box-shadow: 0 0 40px rgba(255,255,255,0.06); touch-action: none; height: 400px; width: 100%; }
  #wallCanvas, #expCanvas { display: block; cursor: crosshair; image-rendering: pixelated; }

  .canvas-status { font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; color: rgba(255,255,255,0.3); margin-top: 10px; letter-spacing: 1px; text-align: center; }

  .dir-btn { background: var(--faint); border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 1.1rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; user-select: none; flex-shrink: 0; }
  .dir-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); }
  .dir-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }

  /* ── TABS & USERNAME BAR ── */
  .username-bar { display: flex; align-items: flex-end; gap: 14px; margin-bottom: 12px; flex-wrap: wrap; border-bottom: 1px solid var(--border); padding-bottom: 0px; }
  .username-display { font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; color: var(--white); background: var(--faint); border: 1px solid var(--border); border-radius: 6px; padding: 7px 14px; letter-spacing: 1px; }
  .username-tag { font-size: 0.68rem; color: rgba(255,255,255,0.3); letter-spacing: 1px; font-family: 'Share Tech Mono', monospace; }

  .chat-tabs-container { display: flex; gap: 4px; overflow-x: auto; flex: 1; min-width: 200px; padding-bottom: 0; margin-bottom: -1px; }
  .chat-tabs-container::-webkit-scrollbar { height: 0px; }

  .chat-tab {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-bottom: none;
    border-radius: 8px 8px 0 0; padding: 8px 16px; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem;
    color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: all 0.2s; white-space: nowrap; z-index: 1;
  }
  .chat-tab:hover { background: rgba(255,255,255,0.08); color: #fff; }
  .chat-tab.active { background: #111; color: #fff; border-color: var(--border); border-top: 2px solid #fff; border-bottom: 1px solid #111; z-index: 3; }
  
  .chat-tab-close { font-size: 0.75rem; color: rgba(255,100,100,0.6); line-height: 1; padding: 2px; border-radius: 4px; transition: all 0.2s; }
  .chat-tab-close:hover { color: #fff; background: rgba(255,100,100,0.8); }

  /* ── CHAT LAYOUT UPDATES ── */
  .chat-layout { display: flex; gap: 14px; margin-bottom: 14px; height: 360px; }
  
  .chat-window { 
    flex: 1; background: rgba(255,255,255,0.02); border: 1px solid var(--border); 
    border-radius: 0 10px 10px 10px; position: relative; overflow: hidden;
  }
  
  .tab-pane { display: none; height: 100%; width: 100%; flex-direction: column; overflow-y: auto; }
  .tab-pane.active { display: flex; }
  .tab-pane::-webkit-scrollbar { width: 4px; }
  .tab-pane::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

  .online-panel { width: 180px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; display: flex; flex-direction: column; padding: 12px; }
  .online-panel-header { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--dim); border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; text-align: center; letter-spacing: 1px; }
  .online-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
  .online-list::-webkit-scrollbar { width: 4px; }
  .online-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

  .online-user { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: #fff; display: flex; align-items: center; gap: 6px; cursor: context-menu; transition: color 0.15s; }
  .online-user:hover { color: rgba(100,255,150,0.8); }
  .online-user::before { content: ''; display: inline-block; width: 6px; height: 6px; background: rgba(100,255,150,0.8); border-radius: 50%; }

  .offline-toggle-wrap { margin-left: auto; display: none; align-items: center; gap: 6px; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--dim); cursor: pointer; margin-bottom: 10px; }
  .offline-toggle-wrap input { cursor: pointer; }

  .chat-msg { font-family: 'Share Tech Mono', monospace; font-size: 0.83rem; line-height: 1.6; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .chat-msg:last-child { border-bottom: none; }
  .chat-msg .ts { color: rgba(255,255,255,0.2); font-size: 0.72rem; margin-right: 6px; }
  .chat-msg .user { color: #fff; font-weight: bold; margin-right: 6px; }
  .chat-msg .text { color: rgba(255,255,255,0.8); }
  .chat-msg.system .text { color: rgba(255,255,255,0.3); font-style: italic; }

  .chat-input-row { display: flex; gap: 10px; }
  .chat-input { flex: 1; background: var(--faint); border: 1px solid var(--border); color: #fff; border-radius: 8px; padding: 10px 14px; font-family: 'Share Tech Mono', monospace; font-size: 0.88rem; outline: none; transition: border-color 0.2s; }
  .chat-input:focus { border-color: rgba(255,255,255,0.45); }
  .chat-input::placeholder { color: rgba(255,255,255,0.2); }
  .chat-send-btn { background: #fff; color: #000; border: none; border-radius: 8px; padding: 10px 22px; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
  .chat-send-btn:hover { background: rgba(255,255,255,0.85); transform: scale(1.03); }

  /* Right Click Context Menu */
  .context-menu { position: absolute; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 6px 0; z-index: 6000; box-shadow: 0 8px 24px rgba(0,0,0,0.8); min-width: 140px; }
  .context-menu.hidden { display: none; }
  .context-menu-item { padding: 10px 16px; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: #fff; cursor: pointer; transition: background 0.2s; letter-spacing: 1px; }
  .context-menu-item:hover { background: rgba(255,255,255,0.1); }

  /* Modals */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(6px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.hidden { display: none; }
  .modal-box { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 36px 32px; width: 100%; max-width: 420px; box-shadow: 0 0 60px rgba(255,255,255,0.08); position: relative; }
  
  .modal-title { font-size: 1.1rem; letter-spacing: 3px; margin-bottom: 8px; }
  .modal-sub { font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; color: var(--dim); margin-bottom: 24px; letter-spacing: 1px; line-height: 1.6; }
  .modal-input { width: 100%; background: var(--faint); border: 1px solid var(--border); color: #fff; border-radius: 8px; padding: 11px 14px; font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; outline: none; margin-bottom: 12px; transition: border-color 0.2s; box-sizing: border-box; }
  .modal-input:focus { border-color: rgba(255,255,255,0.45); }
  .modal-error { font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; color: #ff6b6b; margin-bottom: 0; min-height: 18px; letter-spacing: 1px; flex: 1; text-align: right; }
  
  .modal-btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .modal-btn { flex: 1; background: none; border: 1px solid var(--border); color: #fff; padding: 10px 16px; border-radius: 8px; font-family: 'Orbitron', sans-serif; font-size: 0.78rem; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
  .modal-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); }
  .modal-btn.primary { background: #fff; color: #000; border-color: #fff; }
  .modal-btn.primary:hover { background: rgba(255,255,255,0.88); }
  #pwStep { display: none; }

  /* ToS */
  .tos-link { color: #fff; text-decoration: underline; text-decoration-style: dotted; cursor: pointer; font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; letter-spacing: 1px; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .tos-link:hover { opacity: 0.7; }
  .tos-agree-btn { width: 100%; margin-top: 20px; background: #fff; color: #000; border: none; border-radius: 8px; padding: 13px 20px; font-family: 'Orbitron', sans-serif; font-size: 0.78rem; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
  .tos-agree-btn:hover { background: rgba(255,255,255,0.88); transform: scale(1.02); }
  .tos-decline-btn { width: 100%; margin-top: 10px; background: none; color: rgba(255,255,255,0.35); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 20px; font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
  .tos-decline-btn:hover { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.25); }

  #tosPopup { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
  #tosPopup.hidden { display: none; }
  .tos-popup-box { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 36px 32px; width: 100%; max-width: 640px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 60px rgba(255,255,255,0.08); }
  .tos-popup-box::-webkit-scrollbar { width: 4px; }
  .tos-popup-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
  .tos-popup-title { font-size: 1rem; letter-spacing: 3px; margin-bottom: 4px; }
  .tos-popup-date { font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; color: rgba(255,255,255,0.3); letter-spacing: 2px; margin-bottom: 24px; }
  .tos-popup-body { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; line-height: 1.8; color: rgba(255,255,255,0.75); }
  .tos-popup-body h3 { font-family: 'Orbitron', sans-serif; font-size: 0.78rem; color: #fff; letter-spacing: 2px; margin: 20px 0 8px; }
  .tos-popup-body ul { padding-left: 18px; margin: 6px 0; }
  .tos-popup-body li { margin-bottom: 6px; }
  .tos-close-btn { margin-top: 28px; background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.6); border-radius: 8px; padding: 10px 24px; font-family: 'Orbitron', sans-serif; font-size: 0.78rem; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
  .tos-close-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }

  #canvasLock { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10; display: flex; align-items: center; justify-content: center; font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; color: rgba(255,255,255,0.4); letter-spacing: 2px; border-radius: 10px; }
  #canvasLock.hidden { display: none; }

  .expand-btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.35); color: #fff; padding: 7px 14px; border-radius: 6px; font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; margin-left: auto; height: 100%; }
  .expand-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); box-shadow: 0 0 12px rgba(255,255,255,0.15); }

  /* ── EXPANDED OVERLAY & COLLAPSIBLE TOOLBAR ── */
  #expandedOverlay { position: fixed; inset: 0; background: #000; z-index: 4000; display: flex; flex-direction: column; overflow: hidden; }
  #expandedOverlay.hidden { display: none; }
  #expViewport { flex: 1; position: relative; background: #111; overflow: hidden; }
  #expWrap { position: absolute; top: 0; left: 0; transform-origin: top left; will-change: transform; line-height: 0; }

  .collapsible-toolbar { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.95); border-top: 1px solid var(--border); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; z-index: 5000; }
  .collapsible-toolbar.collapsed { transform: translateY(100%); }
  .exp-toolbar-content { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 12px; padding: 24px 14px; }
  .toggle-toolbar-btn { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); background: rgba(10,10,10,0.95); border: 1px solid var(--border); border-bottom: none; color: rgba(255,255,255,0.6); padding: 4px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; letter-spacing: 1px; transition: color 0.2s; }
  .toggle-toolbar-btn:hover { color: #fff; }
  .exp-close { background: none; border: 1px solid rgba(255,80,80,0.5); color: rgba(255,120,120,0.9); padding: 7px 16px; border-radius: 6px; font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; margin-left: auto; height: 100%; }
  .exp-close:hover { background: rgba(255,60,60,0.15); border-color: rgba(255,100,100,0.9); }

  .exp-dir-btn { position: absolute; background: rgba(0,0,0,0.65); border: 1px solid rgba(255,255,255,0.25); color: #fff; border-radius: 8px; font-size: 1.5rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; user-select: none; z-index: 1000; }
  .exp-dir-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.6); }
  .exp-dir-btn:active { background: rgba(255,255,255,0.35); transform: scale(0.9); }

  #dUp    { top: 20px; left: 50%; transform: translateX(-50%); }
  #dDown  { bottom: 130px; left: 50%; transform: translateX(-50%); } 
  #dLeft  { left: 20px; top: 50%; transform: translateY(-50%); }
  #dRight { right: 20px; top: 50%; transform: translateY(-50%); }
  .exp-coords { position: absolute; bottom: 130px; left: 22px; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: rgba(255,255,255,0.3); letter-spacing: 1px; pointer-events: none; z-index: 1000; } 

  @media (max-width: 600px) {
    .page-title { font-size: 1.8rem; }
    .canvas-toolbar { gap: 6px; }
    .chat-layout { flex-direction: column; height: auto; }
    .online-panel { width: 100%; height: 120px; }
    .chat-window { height: 280px; }
  }
</style>
{% endblock %}

{% block body %}

<div id="userContextMenu" class="context-menu hidden">
  <div class="context-menu-item" id="ctxViewBtn">View Profile</div>
  <div class="context-menu-item" id="ctxEditBtn">Edit Profile</div>
</div>

<div id="tosPopup" class="hidden">
  <div class="tos-popup-box">
    <div class="tos-popup-title">TERMS OF SERVICE: "THE WALL"</div>
    <div class="tos-popup-date">Last Updated: February 23, 2026</div>
    <div class="tos-popup-body">
      <p>Welcome to The Wall at fliphouserecords.com. By clicking "I Agree" or by accessing and using this page, you are entering into a legally binding agreement. If you don't agree to these terms, please head back to the main site.</p>
      <h3>1. COMMUNITY CONDUCT (THE "DON'T BE A JERK" POLICY)</h3>
      <p>"The Wall" is a shared creative space. To keep it functional and fun, you agree not to:</p>
      <ul>
        <li>Post or draw anything illegal, pornographic, or sexually explicit.</li>
        <li>Engage in hate speech, harassment, or threats against individuals or groups.</li>
        <li>Post "Doxxing" information (phone numbers, home addresses, or private data).</li>
        <li>Use bots or scripts to automate drawing or spam the chat room.</li>
      </ul>
      <h3>2. USER-GENERATED CONTENT & LICENSING</h3>
      <p>You own what you create, but because this is a public, shared experience, you grant Flip House Records a non-exclusive, royalty-free, worldwide license to display, record, and share snapshots of "The Wall" (including your contributions) for promotional or archival purposes.</p>
      <h3>3. MODERATION & "THE RIGHT TO ERASE"</h3>
      <p>We don't pre-screen content, but we reserve the right to:</p>
      <ul>
        <li>Wipe the canvas at any time (The "Big Reset").</li>
        <li>Delete specific drawings or chat messages that violate these terms.</li>
        <li>Ban IP addresses or users who repeatedly disrupt the experience.</li>
      </ul>
      <h3>4. DISCLAIMER OF LIABILITY</h3>
      <p>The Wall is provided "As-Is." Flip House Records is not responsible for the content created by users. You understand that you may be exposed to content that is offensive, indecent, or objectionable. We are not liable for any emotional distress, data loss, or technical "glitches" that occur while using this experimental tool.</p>
      <h3>5. AGE REQUIREMENT</h3>
      <p>By using The Wall, you represent that you are at least 13 years of age. If you are under 18, you represent that you have parental permission to be here.</p>
      <h3>6. PRIVACY NOTE</h3>
      <p>We may log IP addresses to prevent abuse and spam. We do not sell your data, but we will cooperate with law enforcement if illegal activity is detected on the platform.</p>
      <h3>7. EMAIL & NEWSLETTER</h3>
      <p>You may optionally provide your email address when reserving a username. Your email is used for password recovery and, if you choose, to receive occasional updates and newsletters from Flip House Records. We will <strong>never</strong> share, sell, or rent your email to any third party. You can opt out at any time by contacting us.</p>
    </div>
    <button class="tos-close-btn" onclick="closeTosPopup()">← CLOSE</button>
  </div>
</div>

<div class="modal-overlay" id="tosModal">
  <div class="modal-box">
    <div class="modal-title">BEFORE YOU ENTER</div>
    <div class="modal-sub">
      This is a shared public space. By continuing, you agree to the rules.<br><br>
      <span class="tos-link" onclick="openTosPopup()">Terms of Service: "The Wall"</span>
      <br><small style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:rgba(255,255,255,0.3);letter-spacing:1px;margin-top:6px;display:block;">↑ click to read the full terms in a new window</small>
    </div>
    <button class="tos-agree-btn" onclick="agreeTos()">I HAVE READ THE TERMS AND I PROMISE TO BE COOL</button>
    <button class="tos-decline-btn" onclick="location.href='/'">No thanks, take me back</button>
  </div>
</div>

<div class="modal-overlay hidden" id="usernameModal">
  <div class="modal-box">
    <div class="modal-title">ENTER THE WALL</div>
    <div class="modal-sub" id="modalSub">
      Type a username or leave blank for a random one.<br>
      Reserved names require a password.
    </div>
    <div id="nameStep">
      <input class="modal-input" type="text" id="usernameInput" placeholder="username (optional)" maxlength="50" autocomplete="off">
      <div class="modal-error" id="modalError"></div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="randomBtn">RANDOM NAME</button>
        <button class="modal-btn primary" id="enterBtn">ENTER</button>
      </div>
    </div>
    <div id="pwStep">
      <div style="font-family:'Share Tech Mono',monospace;font-size:0.82rem;color:var(--dim);margin-bottom:14px;" id="pwLabel"></div>
      
      <input class="modal-input" type="password" id="passwordInput" placeholder="password" maxlength="100" autocomplete="off" style="margin-bottom: 8px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; min-height: 18px;">
        <label style="display: flex; align-items: center; gap: 6px; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--dim); cursor: pointer;" id="rememberMeWrap">
          <input type="checkbox" id="rememberMeCheckbox" checked> Remember me
        </label>
        <div class="modal-error" id="pwError"></div>
      </div>

      <div class="modal-btn-row">
        <button class="modal-btn" id="pwBackBtn">BACK</button>
        <button class="modal-btn primary" id="pwSubmitBtn">CONFIRM</button>
        <button class="modal-btn" id="reserveBtn" style="display:none;">RESERVE NAME</button>
      </div>
      <div style="text-align: center; margin-top: 16px; display: none;" id="forgotPwWrap">
        <span id="forgotPwLink" style="font-family:'Share Tech Mono',monospace; font-size:0.75rem; color:rgba(255,255,255,0.4); cursor:pointer; text-decoration:underline; letter-spacing: 1px;">Forgot password?</span>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="emailModal">
  <div class="modal-box">
    <div class="modal-title">ADD YOUR EMAIL?</div>
    <div class="modal-sub" id="emailModalSub">
      Optionally add your email for password recovery.<br><br>
      <span style="color:rgba(255,255,255,0.4);font-size:0.75rem;">We may also send occasional newsletters — we will never share or sell your information. You can skip this.</span>
    </div>
    <input class="modal-input" type="email" id="emailInput" placeholder="your@email.com (optional)" maxlength="254" autocomplete="email">
    <div class="modal-error" id="emailError"></div>
    <div class="modal-btn-row">
      <button class="modal-btn" id="emailSkipBtn">SKIP</button>
      <button class="modal-btn primary" id="emailSaveBtn">SAVE EMAIL</button>
    </div>
  </div>
</div>

<div id="expandedOverlay" class="hidden">
  <div id="expViewport">
    <div id="expWrap">
      <canvas id="expCanvas"></canvas>
    </div>
    <button class="exp-dir-btn" id="dUp">▲</button>
    <button class="exp-dir-btn" id="dDown">▼</button>
    <button class="exp-dir-btn" id="dLeft">◀</button>
    <button class="exp-dir-btn" id="dRight">▶</button>
    <div class="exp-coords" id="expCoords">x:0  y:0</div>
  </div>

  <div id="expToolbarContainer" class="collapsible-toolbar">
    <button id="toggleToolbarBtn" class="toggle-toolbar-btn" onclick="toggleExpToolbar()">▼ HIDE TOOLS</button>
    <div class="exp-toolbar-content">
      
      <div style="display: flex; gap: 8px;">
        <div class="tool-group-vertical">
          <button class="tool-btn active" id="expBtnDraw" onclick="expSetTool('draw')">✏ DRAW</button>
          <button class="tool-btn sub-btn" onclick="centerCanvas(true)">⌂ CENTER CANVAS</button>
        </div>
        <button class="tool-btn" id="expBtnErase" onclick="expSetTool('erase')">◻ ERASE</button>
        <button class="tool-btn" id="expBtnFill" onclick="expSetTool('fill')">⬛ FILL</button>
      </div>

      <div style="display: flex; gap: 4px; margin: 0 8px;">
        <button class="tool-btn" onclick="zoomExp(1)" title="Zoom In">➕</button>
        <button class="tool-btn" onclick="zoomExp(-1)" title="Zoom Out">➖</button>
      </div>

      <div class="size-slider-wrap">
        <span>SIZE</span>
        <input type="range" id="expBrushSize" min="1" max="20" value="3">
        <span id="expSizeLabel">3</span>
      </div>
      <div id="expPalette" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:0 10px;"></div>
      <input type="color" id="expColorPicker" value="#ffffff" title="Custom color" style="width:32px;height:32px;border:2px solid var(--border);border-radius:50%;cursor:pointer;background:none;padding:0;">
      
      <button class="exp-close" onclick="closeExpanded()" style="margin-left:auto;">✕ CLOSE</button>
    </div>
  </div>
</div>

<div class="page-wrap">
  <h1 class="page-title">THE WALL</h1>
  <p class="page-sub">// LEAVE YOUR MARK //</p>

  <div class="canvas-section">
    <div class="section-header">PAINT — shared canvas, see what the Central Valley has to say.</div>
    <div class="canvas-toolbar">
      
      <div style="display: flex; gap: 8px;">
        <div class="tool-group-vertical">
          <button class="tool-btn active" id="btnDraw" onclick="setTool('draw')">✏ DRAW</button>
          <button class="tool-btn sub-btn" onclick="centerCanvas(false)">⌂ CENTER CANVAS</button>
        </div>
        <button class="tool-btn" id="btnErase" onclick="setTool('erase')">◻ ERASE</button>
        <button class="tool-btn" id="btnFill" onclick="setTool('fill')">⬛ FILL</button>
      </div>

      <div style="display: flex; gap: 4px; margin-left: 10px;">
        <button class="tool-btn" onclick="zoomMain(1)" title="Zoom In">➕</button>
        <button class="tool-btn" onclick="zoomMain(-1)" title="Zoom Out">➖</button>
      </div>

      <div class="size-slider-wrap">
        <span>SIZE</span>
        <input type="range" id="brushSize" min="1" max="20" value="3">
        <span id="sizeLabel">3</span>
      </div>
      <div id="palette" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:0 10px;"></div>
      <input type="color" id="colorPicker" value="#ffffff" title="Custom color">
      <button class="expand-btn" onclick="openExpanded()">⛶ EXPAND</button>
    </div>

    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 14px;">
      <button class="dir-btn" id="mLeft">◀</button>
      
      <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; flex: 1; min-width: 0;">
        <button class="dir-btn" id="mUp">▲</button>
        
        <div class="canvas-outer" id="canvasOuter">
          <div id="mainWrap" style="position:absolute;top:0;left:0;transform-origin:top left;will-change:transform;">
            <canvas id="wallCanvas"></canvas>
          </div>
          <div id="canvasLock">// AGREE TO TERMS TO UNLOCK //</div>
        </div>

        <button class="dir-btn" id="mDown">▼</button>
      </div>
      
      <button class="dir-btn" id="mRight">▶</button>
    </div>
    
    <div class="canvas-status" id="canvasStatus">connecting…</div>
  </div>

  <div class="chat-section">
    <div class="section-header">CHAT — anonymous, real-time</div>
    
    <div class="username-bar">
      <div style="display:flex; align-items: center; gap: 10px;">
        <span class="username-tag">CHATTING AS</span>
        <span class="username-display" id="usernameTag">—</span>
        <button class="tool-btn" onclick="openUsernameModal()" style="font-size:0.75rem;padding:6px 12px;">CHANGE</button>
      </div>
      
      <div class="chat-tabs-container" id="chatTabsContainer">
        <div class="chat-tab active" id="tab-chat" onclick="selectTab('chat')">MAIN CHAT</div>
      </div>
      
      <label class="offline-toggle-wrap" id="offlineToggleWrap">
        <input type="checkbox" id="offlineToggle" onchange="toggleOffline()"> SHOW OFFLINE
      </label>
    </div>
    
    <div class="chat-layout">
      <div class="chat-window" id="chatWindow" style="padding: 0;">
        
        <div class="tab-pane active" id="pane-chat">
          <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px;">
            <div class="chat-msg system"><span class="text">// loading messages…</span></div>
          </div>
        </div>

        </div>
      
      <div class="online-panel">
        <div class="online-panel-header">ONLINE NOW</div>
        <div class="online-list" id="onlineUsersList">
          </div>
      </div>
    </div>

    <div class="chat-input-row" id="chatInputRow">
      <input class="chat-input" type="text" id="chatInput" placeholder="say something…" maxlength="500" autocomplete="off">
      <button class="chat-send-btn" onclick="sendChat()">SEND</button>
    </div>
  </div>
</div>

<footer class="footer">&copy; 2026 Flip House Records</footer>

{% endblock %}

{% block extra_js %}
<script>
// HUGE CANVAS UPGRADE
const COLS = 640, ROWS = 360; 

const canvas = document.getElementById('wallCanvas');
const ctx = canvas.getContext('2d');
canvas.width = COLS;
canvas.height = ROWS;

const outer = document.getElementById('canvasOuter');
const mainWrap = document.getElementById('mainWrap');

let mainPanX = 0, mainPanY = 0;
let mainZoom = 2; // Default scale multiplier for main view
const MAIN_PAN_STEP = 150;

function resizeMainCanvas() {
  canvas.style.width = (COLS * mainZoom) + 'px';
  canvas.style.height = (ROWS * mainZoom) + 'px';
  clampMainPan();
  applyMainPan();
}

function zoomMain(dir) {
  if (dir > 0 && mainZoom < 10) mainZoom++;
  else if (dir < 0 && mainZoom > 1) mainZoom--;
  resizeMainCanvas();
}

function clampMainPan() {
  const maxPanX = Math.max(0, (COLS * mainZoom) - outer.clientWidth);
  const maxPanY = Math.max(0, (ROWS * mainZoom) - outer.clientHeight);
  mainPanX = Math.max(0, Math.min(mainPanX, maxPanX));
  mainPanY = Math.max(0, Math.min(mainPanY, maxPanY));
}

function applyMainPan() {
  mainWrap.style.transform = `translate(${-mainPanX}px,${-mainPanY}px)`;
}

// Automatically center on load
window.addEventListener('load', () => { resizeMainCanvas(); centerCanvas(false); });
window.addEventListener('resize', resizeMainCanvas);

// Main canvas D-pad events
document.getElementById('mUp').addEventListener('click',    () => { mainPanY -= MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mDown').addEventListener('click',  () => { mainPanY += MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mLeft').addEventListener('click',  () => { mainPanX -= MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });
document.getElementById('mRight').addEventListener('click', () => { mainPanX += MAIN_PAN_STEP; clampMainPan(); applyMainPan(); });

function centerCanvas(isExp) {
  if (isExp) {
    const maxPanX = Math.max(0, (COLS * expZoom) - expViewport.clientWidth);
    const maxPanY = Math.max(0, (ROWS * expZoom) - expViewport.clientHeight);
    panX = maxPanX / 2;
    panY = maxPanY / 2;
    applyExpPan();
  } else {
    const maxPanX = Math.max(0, (COLS * mainZoom) - outer.clientWidth);
    const maxPanY = Math.max(0, (ROWS * mainZoom) - outer.clientHeight);
    mainPanX = maxPanX / 2;
    mainPanY = maxPanY / 2;
    applyMainPan();
  }
}

let pixelData = {};

function renderAll() {
  ctx.clearRect(0, 0, COLS, ROWS);
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, COLS, ROWS);
  for (const [key, color] of Object.entries(pixelData)) {
    const [x, y] = key.split(',').map(Number);
    ctx.fillStyle = color;
    ctx.fillRect(x, y, 1, 1);
  }
}

function applyPixels(pixels) {
  for (const p of pixels) {
    const key = `${p.x},${p.y}`;
    if (p.color === 'erase') delete pixelData[key];
    else pixelData[key] = p.color;
  }
  for (const p of pixels) {
    ctx.fillStyle = p.color === 'erase' ? '#111' : p.color;
    ctx.fillRect(p.x, p.y, 1, 1);
  }
}

let currentTool = 'draw';
let currentColor = '#ffffff';
let brushSz = 3;
let isDrawing = false;
let pendingPixels = [];
let flushTimer = null;

function setTool(t) {
  currentTool = t;
  document.querySelectorAll('.tool-btn[id^="btn"], .tool-btn[id^="expBtn"]').forEach(b => b.classList.remove('active'));
  const m = { draw: 'btnDraw', erase: 'btnErase', fill: 'btnFill' };
  const mExp = { draw: 'expBtnDraw', erase: 'expBtnErase', fill: 'expBtnFill' };
  if (m[t]) document.getElementById(m[t]).classList.add('active');
  if (mExp[t]) document.getElementById(mExp[t]).classList.add('active');
  canvas.style.cursor = t === 'erase' ? 'cell' : 'crosshair';
  expCanvas.style.cursor = t === 'erase' ? 'cell' : 'crosshair';
}

const PALETTE = ['#ffffff','#ff4444','#ff8c00','#ffd700','#44ff88','#00cfff','#7b61ff','#ff61d8','#000000','#555555','#c0a060','#1a1a2e'];
const paletteEl = document.getElementById('palette');
PALETTE.forEach(hex => {
  const s = document.createElement('div');
  s.className = 'color-swatch' + (hex === currentColor ? ' selected' : '');
  s.style.background = hex;
  s.title = hex;
  s.addEventListener('click', () => selectColor(hex, s));
  paletteEl.appendChild(s);
});

function selectColor(hex, el) {
  currentColor = hex;
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
  if (el) el.classList.add('selected');
  setTool('draw');
}

document.getElementById('colorPicker').addEventListener('input', e => { selectColor(e.target.value, null); });
document.getElementById('brushSize').addEventListener('input', e => {
  brushSz = parseInt(e.target.value);
  document.getElementById('sizeLabel').textContent = brushSz;
  document.getElementById('expBrushSize').value = brushSz;
  document.getElementById('expSizeLabel').textContent = brushSz;
});

function getCellFromEvent(e, isExp) {
  const targetCanvas = isExp ? expCanvas : canvas;
  const zoom = isExp ? expZoom : mainZoom;
  const rect = targetCanvas.getBoundingClientRect();
  let clientX, clientY;
  if (e.touches) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  return {
    x: Math.max(0, Math.min(COLS-1, Math.floor((clientX - rect.left) / zoom))),
    y: Math.max(0, Math.min(ROWS-1, Math.floor((clientY - rect.top)  / zoom))),
  };
}

function paintAt(x, y) {
  const half = Math.floor(brushSz / 2);
  const batch = [];
  if (currentTool === 'fill') {
    const target = pixelData[`${x},${y}`] || null;
    if (target === currentColor) return;
    const stack = [[x, y]];
    const visited = new Set();
    while (stack.length) {
      const [cx, cy] = stack.pop();
      if (cx < 0 || cy < 0 || cx >= COLS || cy >= ROWS) continue;
      const k = `${cx},${cy}`;
      if (visited.has(k)) continue;
      const cur = pixelData[k] || null;
      if (cur !== target) continue;
      visited.add(k);
      batch.push({ x: cx, y: cy, color: currentColor });
      stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
    }
  } else {
    for (let dx = -half; dx <= half; dx++) {
      for (let dy = -half; dy <= half; dy++) {
        const px = x + dx, py = y + dy;
        if (px < 0 || py < 0 || px >= COLS || py >= ROWS) continue;
        batch.push({ x: px, y: py, color: currentTool === 'erase' ? 'erase' : currentColor });
      }
    }
  }
  if (batch.length) {
    applyPixelsAndSyncExpanded(batch); // Instant visual feedback locally
    pendingPixels.push(...batch);
    scheduleFlush();
  }
}

function scheduleFlush() {
  if (flushTimer) return;
  flushTimer = setTimeout(() => {
    if (pendingPixels.length && canvasWS && canvasWS.readyState === WebSocket.OPEN) {
      canvasWS.send(JSON.stringify({ type: 'draw', pixels: pendingPixels }));
    }
    pendingPixels = [];
    flushTimer = null;
  }, 50);
}

canvas.addEventListener('mousedown', e => { isDrawing = true; const c = getCellFromEvent(e, false); paintAt(c.x, c.y); });
canvas.addEventListener('mousemove', e => { if (!isDrawing) return; const c = getCellFromEvent(e, false); paintAt(c.x, c.y); });
canvas.addEventListener('mouseup', () => { isDrawing = false; });
canvas.addEventListener('mouseleave', () => { isDrawing = false; });
canvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing = true; const c = getCellFromEvent(e, false); paintAt(c.x, c.y); }, { passive: false });
canvas.addEventListener('touchmove', e => { e.preventDefault(); if (!isDrawing) return; const c = getCellFromEvent(e, false); paintAt(c.x, c.y); }, { passive: false });
canvas.addEventListener('touchend', () => { isDrawing = false; });

let canvasWS;
const canvasStatus = document.getElementById('canvasStatus');

function connectCanvas() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  canvasWS = new WebSocket(`${proto}://${location.host}/ws/canvas/`);
  canvasWS.onopen = () => { canvasStatus.textContent = '● connected'; canvasStatus.style.color = 'rgba(100,255,150,0.6)'; };
  canvasWS.onclose = () => { canvasStatus.textContent = '○ disconnected — retrying…'; canvasStatus.style.color = 'rgba(255,100,100,0.5)'; setTimeout(connectCanvas, 3000); };
  canvasWS.onerror = () => { canvasStatus.textContent = '○ connection error'; };
  canvasWS.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'canvas_init') { pixelData = msg.data || {}; renderAll(); if (_expandedOpen) renderExpanded(); }
    else if (msg.type === 'draw') { applyPixelsAndSyncExpanded(msg.pixels); }
    else if (msg.type === 'clear') { pixelData = {}; renderAll(); if (_expandedOpen) renderExpanded(); }
  };
}
connectCanvas();
renderAll();

let chatWS;
let myUsername = null;
const chatMessages = document.getElementById('chatMessages');
const HISTORY = {{ messages_json|safe }};

function connectChat() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  chatWS = new WebSocket(`${proto}://${location.host}/ws/chat/`);
  
  chatWS.onopen = () => {
    const token = localStorage.getItem('wall_auth_token');
    if (token && sessionStorage.getItem('wall_tos_agreed') === '1') {
      chatWS.send(JSON.stringify({ type: 'token_login', token: token }));
    }
  };
  
  chatWS.onclose = () => { setTimeout(connectChat, 3000); };
  chatWS.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'message') appendMessage(msg.username, msg.message, msg.timestamp, false);
    else if (msg.type === 'username_status') handleUsernameStatus(msg);
    else if (msg.type === 'reserve_result') handleReserveResult(msg);
    else if (msg.type === 'auth_result') handleAuthResult(msg);
    else if (msg.type === 'email_result') handleEmailResult(msg);
    else if (msg.type === 'presence_list') updateOnlineUsers(msg.users);
    else if (msg.type === 'token_login_result') handleTokenLoginResult(msg);
  };
}
connectChat();

function handleTokenLoginResult(msg) {
  if (msg.success) {
    pendingUsername = msg.username;
    finalizeUsername(msg.username);
  } else {
    localStorage.removeItem('wall_auth_token');
    if (sessionStorage.getItem('wall_tos_agreed') === '1') {
      openUsernameModal();
    }
  }
}

function appendMessage(username, message, ts, isSystem) {
  const div = document.createElement('div');
  div.className = 'chat-msg' + (isSystem ? ' system' : '');
  if (isSystem) div.innerHTML = `<span class="text">${escapeHtml(message)}</span>`;
  else div.innerHTML = `<span class="ts">[${ts}]</span><span class="user">${escapeHtml(username)}:</span><span class="text">${escapeHtml(message)}</span>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function escapeHtml(s) { 
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}

chatMessages.innerHTML = '';
if (HISTORY.length === 0) appendMessage('', '// no messages yet — be the first //', '', true);
else for (const m of HISTORY) appendMessage(m.username, m.message, m.timestamp, false);

function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !myUsername || !chatWS || chatWS.readyState !== WebSocket.OPEN) return;
  chatWS.send(JSON.stringify({ type: 'chat_message', username: myUsername, message: text }));
  input.value = '';
}
document.getElementById('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });

const modal = document.getElementById('usernameModal');
let pendingUsername = null;
function generateRandomName() {
  const adj = ['cosmic','dusty','frozen','neon','glitch','vapor','turbo','indie','lunar','wired'];
  const noun = ['bass','beat','flip','groove','sample','scratch','synth','vinyl','wave','zone'];
  return `${adj[Math.floor(Math.random()*adj.length)]}-${noun[Math.floor(Math.random()*noun.length)]}-${Math.floor(Math.random()*90)+10}`;
}
document.getElementById('randomBtn').addEventListener('click', () => { document.getElementById('usernameInput').value = generateRandomName(); });
document.getElementById('enterBtn').addEventListener('click', () => {
  let name = document.getElementById('usernameInput').value.trim();
  if (!name) name = generateRandomName();
  pendingUsername = name;
  if (!chatWS || chatWS.readyState !== WebSocket.OPEN) { finalizeUsername(name); return; }
  chatWS.send(JSON.stringify({ type: 'check_username', username: name }));
});
document.getElementById('usernameInput').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('enterBtn').click(); });

function handleUsernameStatus(msg) {
  if (!msg.taken) showPwStep(`"${msg.username}" is available. Set a password to reserve it, or skip.`, false);
  else showPwStep(`"${msg.username}" is reserved. Enter the password to use it.`, true);
}

function showPwStep(label, isLogin) {
  document.getElementById('nameStep').style.display = 'none';
  document.getElementById('pwStep').style.display = 'block';
  document.getElementById('pwLabel').textContent = label;
  document.getElementById('passwordInput').value = '';
  const pwError = document.getElementById('pwError');
  pwError.textContent = ''; pwError.style.color = '#ff6b6b'; 
  
  const reserveBtn = document.getElementById('reserveBtn');
  const submitBtn = document.getElementById('pwSubmitBtn');
  const forgotWrap = document.getElementById('forgotPwWrap');
  
  if (isLogin) { 
    submitBtn.textContent = 'LOGIN'; 
    reserveBtn.style.display = 'none'; 
    forgotWrap.style.display = 'block'; 
  } else { 
    submitBtn.textContent = 'SKIP'; 
    reserveBtn.style.display = 'block'; 
    reserveBtn.textContent = 'RESERVE NAME'; 
    forgotWrap.style.display = 'none'; 
  }
}

document.getElementById('pwBackBtn').addEventListener('click', () => { document.getElementById('nameStep').style.display = 'block'; document.getElementById('pwStep').style.display = 'none'; document.getElementById('modalError').textContent = ''; });
document.getElementById('pwSubmitBtn').addEventListener('click', () => {
  const pw = document.getElementById('passwordInput').value;
  if (document.getElementById('pwSubmitBtn').textContent === 'LOGIN') chatWS.send(JSON.stringify({ type: 'auth_username', username: pendingUsername, password: pw }));
  else finalizeUsername(pendingUsername);
});
document.getElementById('reserveBtn').addEventListener('click', () => {
  const pw = document.getElementById('passwordInput').value;
  if (!pw) { document.getElementById('pwError').textContent = 'Enter a password to reserve.'; return; }
  chatWS.send(JSON.stringify({ type: 'reserve_username', username: pendingUsername, password: pw }));
});
document.getElementById('forgotPwLink').addEventListener('click', () => {
  if (!pendingUsername) return;
  if (confirm("Send a password reset email to the address on file for " + pendingUsername + "?")) {
    const pwErr = document.getElementById('pwError');
    if (chatWS && chatWS.readyState === WebSocket.OPEN) {
      chatWS.send(JSON.stringify({ type: 'forgot_password', username: pendingUsername }));
      pwErr.style.color = "rgba(100,255,150,0.8)"; pwErr.textContent = "Reset request sent. Check your email.";
    } else {
      pwErr.style.color = "#ff6b6b"; pwErr.textContent = "Not connected. Try again.";
    }
  }
});

function handleReserveResult(msg) {
  if (msg.success) { 
    if (document.getElementById('rememberMeCheckbox').checked) {
      localStorage.setItem('wall_auth_token', msg.token);
    } else {
      localStorage.removeItem('wall_auth_token');
    }
    finalizeUsername(pendingUsername); 
    setTimeout(() => openEmailModal('Add your email for password recovery.<br><br><span style="color:rgba(255,255,255,0.4);font-size:0.75rem;">We may also send occasional newsletters — we will never share or sell your information. You can skip this.</span>'), 400); 
  }
  else { document.getElementById('pwError').style.color = '#ff6b6b'; document.getElementById('pwError').textContent = msg.error || 'Error.'; }
}

function handleAuthResult(msg) {
  if (msg.success) { 
    if (document.getElementById('rememberMeCheckbox').checked) {
      localStorage.setItem('wall_auth_token', msg.token);
    } else {
      localStorage.removeItem('wall_auth_token');
    }
    
    finalizeUsername(pendingUsername); 
    
    if (!msg.has_email) setTimeout(() => openEmailModal("Welcome back! You don't have an email on file.<br><br>Add one for password recovery — we may also send occasional newsletters. <span style='color:rgba(255,255,255,0.4);font-size:0.75rem;'>We will never share or sell your information.</span>"), 400); 
  }
  else { document.getElementById('pwError').style.color = '#ff6b6b'; document.getElementById('pwError').textContent = msg.error || 'Wrong password.'; }
}

function handleEmailResult(msg) {
  if (msg.success) { closeEmailModal(); appendMessage('', '// email saved successfully //', '', true); }
  else { document.getElementById('emailError').textContent = msg.error || 'Could not save email.'; }
}

function finalizeUsername(name) { 
  myUsername = name; 
  document.getElementById('usernameTag').textContent = name; 
  modal.classList.add('hidden'); 
  appendMessage('', `// you joined as ${name} //`, '', true); 
  
  document.getElementById('offlineToggleWrap').style.display = 'flex';
  if (chatWS && chatWS.readyState === WebSocket.OPEN) {
    chatWS.send(JSON.stringify({ 
      type: 'presence_update', 
      username: myUsername, 
      offline: document.getElementById('offlineToggle').checked 
    }));
  }
}

// ── ONLINE NOW & TAB/PROFILE LOGIC ──
function toggleOffline() {
  if (!myUsername || !chatWS || chatWS.readyState !== WebSocket.OPEN) return;
  const isOffline = document.getElementById('offlineToggle').checked;
  chatWS.send(JSON.stringify({ 
    type: 'presence_update', 
    username: myUsername, 
    offline: isOffline 
  }));
}

function updateOnlineUsers(users) {
  const listEl = document.getElementById('onlineUsersList');
  listEl.innerHTML = '';
  if (users.length === 0) {
    listEl.innerHTML = '<span style="color:var(--dim); font-size:0.7rem;">It is quiet in here...</span>';
    return;
  }
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'online-user';
    div.textContent = user;
    div.setAttribute('data-username', user);
    listEl.appendChild(div);
  });
}

// Context Menu Setup
const ctxMenu = document.getElementById('userContextMenu');
let contextMenuTargetUser = null;

document.getElementById('onlineUsersList').addEventListener('contextmenu', e => {
  const userDiv = e.target.closest('.online-user');
  if (!userDiv) return;
  e.preventDefault();
  
  contextMenuTargetUser = userDiv.getAttribute('data-username');
  
  ctxMenu.style.left = e.pageX + 'px';
  ctxMenu.style.top = e.pageY + 'px';
  ctxMenu.classList.remove('hidden');
  
  if (contextMenuTargetUser === myUsername) {
    document.getElementById('ctxEditBtn').style.display = 'block';
    document.getElementById('ctxViewBtn').style.display = 'none';
  } else {
    document.getElementById('ctxEditBtn').style.display = 'none';
    document.getElementById('ctxViewBtn').style.display = 'block';
  }
});

document.addEventListener('click', () => { ctxMenu.classList.add('hidden'); });

const DEFAULT_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23222'/><text x='50' y='55' font-size='40' fill='%23555' font-family='monospace' text-anchor='middle' dominant-baseline='middle'>?</text></svg>";

document.getElementById('ctxViewBtn').addEventListener('click', () => fetchAndOpenProfile(contextMenuTargetUser, false));
document.getElementById('ctxEditBtn').addEventListener('click', () => fetchAndOpenProfile(contextMenuTargetUser, true));

// Tab Logic
function selectTab(targetTab) {
  document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  
  const tab = document.getElementById('tab-' + targetTab);
  const pane = document.getElementById('pane-' + targetTab);
  if (tab) tab.classList.add('active');
  if (pane) pane.classList.add('active');
  
  const inputRow = document.getElementById('chatInputRow');
  if (targetTab === 'chat') {
    inputRow.style.display = 'flex';
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } else {
    inputRow.style.display = 'none';
  }
}

function closeTab(targetUser, event) {
  event.stopPropagation();
  const tab = document.getElementById('tab-' + targetUser);
  const pane = document.getElementById('pane-' + targetUser);
  const wasActive = tab && tab.classList.contains('active');
  
  if (tab) tab.remove();
  if (pane) pane.remove();
  
  if (wasActive) {
    selectTab('chat');
  }
}

function renderProfilePane(paneId, targetUser, data, isEditMode) {
  const pane = document.getElementById(paneId);
  const avatarSrc = data.avatar_url || DEFAULT_AVATAR;
  
  const locHtml = isEditMode 
    ? `<input class="modal-input" type="text" id="loc-${targetUser}" maxlength="100" placeholder="Where are you?" value="${escapeHtml(data.location)}" style="margin-bottom:0; padding: 8px 12px; background:rgba(255,255,255,0.04);">` 
    : `<div style="font-family:'Share Tech Mono', monospace; font-size: 0.85rem; color: #fff; min-height: 18px;">${escapeHtml(data.location) || 'Location not set.'}</div>`;
    
  const bioHtml = isEditMode 
    ? `<textarea class="modal-input" id="bio-${targetUser}" maxlength="500" placeholder="Tell us about yourself..." style="resize:vertical; min-height:80px; font-family: sans-serif; padding: 8px 12px; line-height: 1.4; background:rgba(255,255,255,0.04);">${escapeHtml(data.bio)}</textarea>` 
    : `<div style="font-family:'Share Tech Mono', monospace; font-size: 0.85rem; color: #fff; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(data.bio) || 'No bio available.'}</div>`;

  let html = `
    <div style="padding: 24px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column;">
      <div style="display:flex; gap: 24px; margin-bottom: 20px;">
        <div style="text-align: center; flex-shrink: 0; width: 120px;">
          <img id="img-${targetUser}" src="${avatarSrc}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); display: block; margin-bottom: 12px; background: #111;">
          ${isEditMode ? `<label style="font-family:'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--dim); cursor: pointer; text-decoration: underline; letter-spacing: 1px;">UPLOAD PNG<input type="file" accept="image/png" style="display:none;" id="file-${targetUser}" onchange="previewAvatar(this, '${targetUser}')"></label>` : ''}
        </div>
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 1.4rem; letter-spacing: 2px; margin-bottom: 6px; word-wrap: break-word; text-shadow: 0 0 10px rgba(255,255,255,0.2);">${escapeHtml(data.username)}</div>
          <div style="font-family:'Share Tech Mono', monospace; font-size: 0.7rem; color: rgba(255,255,255,0.3); margin-bottom: 16px; letter-spacing: 1px;">LAST SEEN: <span style="color:var(--dim);">${data.last_login}</span></div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-family:'Share Tech Mono', monospace; font-size: 0.65rem; color: rgba(255,255,255,0.4); margin-bottom: 4px; letter-spacing: 1px;">LOCATION</div>
            ${locHtml}
          </div>

          <div>
            <div style="font-family:'Share Tech Mono', monospace; font-size: 0.65rem; color: rgba(255,255,255,0.4); margin-bottom: 4px; letter-spacing: 1px;">BIO</div>
            ${bioHtml}
          </div>
        </div>
      </div>
      ${isEditMode ? `<div style="margin-top: auto; display:flex; justify-content: flex-end; padding-top:10px;"><button class="modal-btn primary" style="flex:none; padding:10px 24px;" id="btn-save-${targetUser}" onclick="saveProfile('${targetUser}')">SAVE PROFILE</button></div>` : ''}
    </div>
  `;
  pane.innerHTML = html;
}

function previewAvatar(input, targetUser) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('img-' + targetUser).src = e.target.result;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

async function fetchAndOpenProfile(targetUser, isEditMode) {
  const tabId = 'tab-' + targetUser;
  const paneId = 'pane-' + targetUser;

  if (document.getElementById(tabId)) {
    selectTab(targetUser);
    return;
  }

  const tabsContainer = document.getElementById('chatTabsContainer');
  const tab = document.createElement('div');
  tab.className = 'chat-tab';
  tab.id = tabId;
  const title = isEditMode ? 'EDIT: ' + targetUser : targetUser;
  
  tab.innerHTML = `<span>${title}</span>`;
  const closeBtn = document.createElement('span');
  closeBtn.className = 'chat-tab-close';
  closeBtn.textContent = '✕';
  closeBtn.onclick = (e) => closeTab(targetUser, e);
  tab.appendChild(closeBtn);
  tab.onclick = () => selectTab(targetUser);
  tabsContainer.appendChild(tab);

  const contentArea = document.getElementById('chatWindow');
  const pane = document.createElement('div');
  pane.className = 'tab-pane';
  pane.id = paneId;
  pane.innerHTML = `<div style="padding: 40px; color:var(--dim); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; text-align: center;">Loading...</div>`;
  contentArea.appendChild(pane);

  selectTab(targetUser);

  try {
    const res = await fetch(`/api/profile/${targetUser}/`);
    const data = await res.json();
    if (data.success) {
      renderProfilePane(paneId, targetUser, data, isEditMode);
    } else {
      pane.innerHTML = `<div style="padding: 40px; color:#ff6b6b; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; text-align: center;">Error loading profile.</div>`;
    }
  } catch (err) {
    console.error(err);
    pane.innerHTML = `<div style="padding: 40px; color:#ff6b6b; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; text-align: center;">Network error.</div>`;
  }
}

async function saveProfile(targetUser) {
  const saveBtn = document.getElementById('btn-save-' + targetUser);
  saveBtn.textContent = 'SAVING...';
  
  const formData = new FormData();
  formData.append('token', localStorage.getItem('wall_auth_token'));
  formData.append('location', document.getElementById('loc-' + targetUser).value);
  formData.append('bio', document.getElementById('bio-' + targetUser).value);
  
  const avatarFile = document.getElementById('file-' + targetUser).files[0];
  if (avatarFile) {
    formData.append('avatar', avatarFile);
  }

  try {
    const res = await fetch('/api/profile/update/', { 
      method: 'POST', 
      body: formData 
    });
    const data = await res.json();
    if (data.success) {
      saveBtn.textContent = 'SAVED!';
      saveBtn.style.background = '#44ff88';
      setTimeout(() => {
        saveBtn.textContent = 'SAVE PROFILE';
        saveBtn.style.background = '#fff';
      }, 2000);
      
      if (data.avatar_url) {
        document.getElementById('img-' + targetUser).src = data.avatar_url;
      }
    } else {
      alert(data.error || 'Failed to save profile.');
      saveBtn.textContent = 'SAVE PROFILE';
    }
  } catch (err) {
    console.error(err);
    alert('Network error while saving profile.');
    saveBtn.textContent = 'SAVE PROFILE';
  }
}
// ── END ONLINE NOW & TAB/PROFILE LOGIC ──

function openUsernameModal() { 
  modal.classList.remove('hidden'); 
  document.getElementById('nameStep').style.display = 'block'; 
  document.getElementById('pwStep').style.display = 'none'; 
  
  const savedName = localStorage.getItem('wall_saved_username');
  document.getElementById('usernameInput').value = myUsername || savedName || ''; 
  
  document.getElementById('modalError').textContent = ''; 
}

const emailModal = document.getElementById('emailModal');
function openEmailModal(subText) { if (subText) document.getElementById('emailModalSub').innerHTML = subText; document.getElementById('emailInput').value = ''; document.getElementById('emailError').textContent = ''; emailModal.classList.remove('hidden'); }
function closeEmailModal() { emailModal.classList.add('hidden'); }
document.getElementById('emailSkipBtn').addEventListener('click', closeEmailModal);
document.getElementById('emailSaveBtn').addEventListener('click', () => {
  const email = document.getElementById('emailInput').value.trim();
  if (!email || !myUsername) { closeEmailModal(); return; }
  if (!chatWS || chatWS.readyState !== WebSocket.OPEN) { document.getElementById('emailError').textContent = 'Not connected. Try again.'; return; }
  chatWS.send(JSON.stringify({ type: 'save_email', username: myUsername, email }));
});
document.getElementById('emailInput').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('emailSaveBtn').click(); });

const tosModal = document.getElementById('tosModal');
const tosPopup = document.getElementById('tosPopup');
function openTosPopup() { tosPopup.classList.remove('hidden'); }
function closeTosPopup() { tosPopup.classList.add('hidden'); }

function agreeTos() { 
  sessionStorage.setItem('wall_tos_agreed', '1'); 
  tosModal.classList.add('hidden'); 
  document.getElementById('canvasLock').classList.add('hidden'); 
  
  const token = localStorage.getItem('wall_auth_token');
  if (token && chatWS && chatWS.readyState === WebSocket.OPEN) {
    chatWS.send(JSON.stringify({ type: 'token_login', token: token }));
  } else {
    openUsernameModal();
  }
}

window.addEventListener('load', () => {
  if (sessionStorage.getItem('wall_tos_agreed') === '1') { 
    tosModal.classList.add('hidden'); 
    document.getElementById('canvasLock').classList.add('hidden'); 
    
    if (!localStorage.getItem('wall_auth_token')) {
      openUsernameModal(); 
    }
  } else { 
    tosModal.classList.remove('hidden'); 
  }
});

// ═══════════════════════════════════════════════════
// EXPANDED CANVAS  (Zoomable, pannable viewport)
// ═══════════════════════════════════════════════════
const expCanvas  = document.getElementById('expCanvas');
const expCtx     = expCanvas.getContext('2d');
const expWrap    = document.getElementById('expWrap');
const expViewport= document.getElementById('expViewport');
const expCoords  = document.getElementById('expCoords');

expCanvas.width  = COLS;
expCanvas.height = ROWS;

let panX = 0, panY = 0;
let expZoom = 6; 
const EXP_PAN_STEP = 200; 

function resizeExpCanvas() {
  expCanvas.style.width = (COLS * expZoom) + 'px';
  expCanvas.style.height = (ROWS * expZoom) + 'px';
  clampPan();
  applyExpPan();
}

function zoomExp(dir) {
  if (dir > 0 && expZoom < 25) expZoom++;
  else if (dir < 0 && expZoom > 1) expZoom--;
  resizeExpCanvas();
}

function clampPan() {
  const maxX = Math.max(0, (COLS * expZoom) - expViewport.clientWidth);
  const maxY = Math.max(0, (ROWS * expZoom) - expViewport.offsetHeight);
  panX = Math.max(0, Math.min(panX, maxX));
  panY = Math.max(0, Math.min(panY, maxY));
}

function applyExpPan() {
  expWrap.style.transform = `translate(${-panX}px,${-panY}px)`;
  expCoords.textContent = `x:${Math.round(panX/expZoom)}  y:${Math.round(panY/expZoom)}`;
}

function renderExpanded() {
  expCtx.clearRect(0, 0, COLS, ROWS);
  expCtx.fillStyle = '#111';
  expCtx.fillRect(0, 0, COLS, ROWS);
  for (const [key, color] of Object.entries(pixelData)) {
    const [x, y] = key.split(',').map(Number);
    expCtx.fillStyle = color;
    expCtx.fillRect(x, y, 1, 1);
  }
}

let _expandedOpen = false;
function applyPixelsAndSyncExpanded(pixels) {
  applyPixels(pixels);
  if (_expandedOpen) {
    for (const p of pixels) {
      expCtx.fillStyle = p.color === 'erase' ? '#111' : p.color;
      expCtx.fillRect(p.x, p.y, 1, 1);
    }
  }
}

let expDrawing = false;
expCanvas.addEventListener('mousedown', e => { expDrawing = true; const c = getCellFromEvent(e, true); paintAt(c.x, c.y); });
expCanvas.addEventListener('mousemove', e => { if (!expDrawing) return; const c = getCellFromEvent(e, true); paintAt(c.x, c.y); });
expCanvas.addEventListener('mouseup',    () => { expDrawing = false; });
expCanvas.addEventListener('mouseleave', () => { expDrawing = false; });
expCanvas.addEventListener('touchstart', e => { e.preventDefault(); expDrawing = true;  const c = getCellFromEvent(e, true); paintAt(c.x,c.y); }, { passive:false });
expCanvas.addEventListener('touchmove',  e => { e.preventDefault(); if (!expDrawing) return; const c = getCellFromEvent(e, true); paintAt(c.x,c.y); }, { passive:false });
expCanvas.addEventListener('touchend',   () => { expDrawing = false; });

document.getElementById('dUp').addEventListener('click',    () => { panY -= EXP_PAN_STEP; clampPan(); applyExpPan(); });
document.getElementById('dDown').addEventListener('click',  () => { panY += EXP_PAN_STEP; clampPan(); applyExpPan(); });
document.getElementById('dLeft').addEventListener('click',  () => { panX -= EXP_PAN_STEP; clampPan(); applyExpPan(); });
document.getElementById('dRight').addEventListener('click', () => { panX += EXP_PAN_STEP; clampPan(); applyExpPan(); });

window.addEventListener('keydown', e => {
  if (document.getElementById('expandedOverlay').classList.contains('hidden')) return;
  if (e.key === 'ArrowUp')    { panY -= EXP_PAN_STEP; clampPan(); applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowDown')  { panY += EXP_PAN_STEP; clampPan(); applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowLeft')  { panX -= EXP_PAN_STEP; clampPan(); applyExpPan(); e.preventDefault(); }
  if (e.key === 'ArrowRight') { panX += EXP_PAN_STEP; clampPan(); applyExpPan(); e.preventDefault(); }
  if (e.key === 'Escape')     { closeExpanded(); }
});

function expSetTool(t) { setTool(t); }

const expPaletteEl = document.getElementById('expPalette');
PALETTE.forEach(hex => {
  const s = document.createElement('div');
  s.className = 'color-swatch' + (hex === currentColor ? ' selected' : '');
  s.style.background = hex;
  s.title = hex;
  s.addEventListener('click', () => { selectColor(hex, s); });
  expPaletteEl.appendChild(s);
});

document.getElementById('expColorPicker').addEventListener('input', e => { selectColor(e.target.value, null); });
document.getElementById('expBrushSize').addEventListener('input', e => {
  brushSz = parseInt(e.target.value);
  document.getElementById('expSizeLabel').textContent = brushSz;
  document.getElementById('brushSize').value = Math.min(brushSz, 20);
  document.getElementById('sizeLabel').textContent = brushSz;
});

function toggleExpToolbar() {
  const tb = document.getElementById('expToolbarContainer');
  const btn = document.getElementById('toggleToolbarBtn');
  if (tb.classList.contains('collapsed')) {
    tb.classList.remove('collapsed');
    btn.textContent = '▼ HIDE TOOLS';
  } else {
    tb.classList.add('collapsed');
    btn.textContent = '▲ SHOW TOOLS';
  }
}

function openExpanded() {
  _expandedOpen = true;
  document.getElementById('expandedOverlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  resizeExpCanvas();
  renderExpanded();
  centerCanvas(true);
  setTool(currentTool);
  document.getElementById('expBrushSize').value = brushSz;
  document.getElementById('expSizeLabel').textContent = brushSz;
}

function closeExpanded() {
  _expandedOpen = false;
  document.getElementById('expandedOverlay').classList.add('hidden');
  document.body.style.overflow = '';
  renderAll();
}
</script>
{% endblock %}